Page({
  data: {
    navItems: [{ "id": 8, "short_title": "安全制度", "files": [], "title": "消防安全制度", "optionSelect": [], "type": 1, "optionList": [{ "val": 10, "id": 28, "title": "有", "questionId": 8, "status": 1, "orders": "", "keyWord": "" }, { "val": 6, "id": 29, "title": "无", "questionId": 8, "status": 1, "orders": "", "keyWord": "" }] }, { "id": 9, "short_title": "培训演练", "files": [], "title": "员工消防安全培训与演练", "optionSelect": [], "type": 1, "optionList": [{ "val": 10, "id": 30, "title": "组织开展", "questionId": 9, "status": 1, "orders": "", "keyWord": "" }, { "val": 0, "id": 31, "title": "未组织开展", "questionId": 9, "status": 1, "orders": "", "keyWord": "" }] }, { "id": 10, "short_title": "应急预案", "files": [], "title": "灭火和应急疏散预案", "optionSelect": [], "type": 1, "optionList": [{ "val": 10, "id": 32, "title": "有", "questionId": 10, "status": 1, "orders": "", "keyWord": "" }, { "val": 0, "id": 33, "title": "无", "questionId": 10, "status": 1, "orders": "", "keyWord": "" }] }, { "id": 12, "short_title": "消防车道", "files": [], "title": "消防车通道", "optionSelect": [], "type": 1, "optionList": [{ "val": 10, "id": 36, "title": "畅通", "questionId": 12, "status": 1, "orders": "", "keyWord": "" }, { "val": 6, "id": 37, "title": "被堵塞、占用", "questionId": 12, "status": 1, "orders": "", "keyWord": "" }, { "val": 0, "id": 38, "title": "无", "questionId": 12, "status": 1, "orders": "", "keyWord": "" }] }, { "id": 2, "short_title": "疏散通道", "files": [], "title": "疏散通道", "optionSelect": [], "type": 1, "optionList": [{ "val": 10, "id": 7, "title": "畅通", "questionId": 2, "status": 1, "orders": "", "keyWord": "" }, { "val": 6, "id": 8, "title": "堵塞", "questionId": 2, "status": 1, "orders": "", "keyWord": "" }, { "val": 3, "id": 9, "title": "锁闭", "questionId": 2, "status": 1, "orders": "", "keyWord": "" }] }, { "id": 3, "short_title": "安全出口", "files": [], "title": "安全出口", "optionSelect": [], "type": 1, "optionList": [{ "val": 10, "id": 10, "title": "畅通", "questionId": 3, "status": 1, "orders": "", "keyWord": "" }, { "val": 6, "id": 11, "title": "堵塞", "questionId": 3, "status": 1, "orders": "", "keyWord": "" }, { "val": 3, "id": 12, "title": "锁闭", "questionId": 3, "status": 1, "orders": "", "keyWord": "" }, { "val": 0, "id": 13, "title": "缺少", "questionId": 3, "status": 1, "orders": "", "keyWord": "" }] }, { "id": 13, "short_title": "防火门", "files": [], "title": "防火门", "optionSelect": [], "type": 1, "optionList": [{ "val": 10, "id": 39, "title": "完好有效", "questionId": 13, "status": 1, "orders": "", "keyWord": "" }, { "val": 6, "id": 40, "title": "常闭式防火门常开", "questionId": 13, "status": 1, "orders": "", "keyWord": "" }, { "val": 3, "id": 41, "title": "损坏", "questionId": 13, "status": 1, "orders": "", "keyWord": "" }, { "val": 10, "id": 42, "title": "不涉及", "questionId": 13, "status": 1, "orders": "", "keyWord": "" }] }, { "id": 4, "short_title": "疏散指示", "files": [], "title": "疏散指示标志", "optionSelect": [], "type": 1, "optionList": [{ "val": 10, "id": 14, "title": "完好有效", "questionId": 4, "status": 1, "orders": "", "keyWord": "" }, { "val": 6, "id": 15, "title": "损坏", "questionId": 4, "status": 1, "orders": "", "keyWord": "" }, { "val": 3, "id": 16, "title": "缺少", "questionId": 4, "status": 1, "orders": "", "keyWord": "" }, { "val": 0, "id": 17, "title": "无", "questionId": 4, "status": 1, "orders": "", "keyWord": "" }] }, { "id": 5, "short_title": "应急照明", "files": [], "title": "应急照明", "optionSelect": [], "type": 1, "optionList": [{ "val": 10, "id": 18, "title": "完好有效", "questionId": 5, "status": 1, "orders": "", "keyWord": "" }, { "val": 6, "id": 19, "title": "损坏", "questionId": 5, "status": 1, "orders": "", "keyWord": "" }, { "val": 3, "id": 20, "title": "缺少", "questionId": 5, "status": 1, "orders": "", "keyWord": "" }, { "val": 0, "id": 21, "title": "无", "questionId": 5, "status": 1, "orders": "", "keyWord": "" }] }, { "id": 6, "short_title": "障碍物", "files": [], "title": "人员密集场所外墙门窗上是否设置影响逃生、灭火救援的障碍物", "optionSelect": [], "type": 1, "optionList": [{ "val": 10, "id": 22, "title": "否", "questionId": 6, "status": 1, "orders": "", "keyWord": "" }, { "val": 0, "id": 23, "title": "是", "questionId": 6, "status": 1, "orders": "", "keyWord": "" }, { "val": 10, "id": 24, "title": "不涉及", "questionId": 6, "status": 1, "orders": "", "keyWord": "" }] }, { "id": 14, "short_title": "消火栓", "files": [], "title": "室内消火栓", "optionSelect": [], "type": 1, "optionList": [{ "val": 0, "id": 43, "title": "未设置", "questionId": 14, "status": 1, "orders": "", "keyWord": "" }, { "val": 10, "id": 44, "title": "完好有效", "questionId": 14, "status": 1, "orders": "", "keyWord": "" }, { "val": 6, "id": 45, "title": "损坏", "questionId": 14, "status": 1, "orders": "", "keyWord": "" }, { "val": 3, "id": 46, "title": "无水", "questionId": 14, "status": 1, "orders": "", "keyWord": "" }, { "val": 0, "id": 47, "title": "配件不齐", "questionId": 14, "status": 1, "orders": "", "keyWord": "" }, { "val": 0, "id": 48, "title": "被遮挡、圈占", "questionId": 14, "status": 1, "orders": "", "keyWord": "" }, { "val": 10, "id": 49, "title": "不涉及", "questionId": 14, "status": 1, "orders": "", "keyWord": "" }] }, { "id": 1, "short_title": "灭火器", "files": [], "title": "灭火器", "optionSelect": [], "type": 1, "optionList": [{ "val": 1, "id": 1, "title": "未设置", "questionId": 1, "status": 1, "orders": "", "keyWord": "" }, { "val": 10, "id": 2, "title": "完好有效", "questionId": 1, "status": 1, "orders": "", "keyWord": "" }, { "val": 3, "id": 3, "title": "失效", "questionId": 1, "status": 1, "orders": "", "keyWord": "" }, { "val": 3, "id": 4, "title": "缺少", "questionId": 1, "status": 1, "orders": "", "keyWord": "" }, { "val": 3, "id": 5, "title": "配置类型错误", "questionId": 1, "status": 1, "orders": "", "keyWord": "" }, { "val": 6, "id": 6, "title": "设置位置不当", "questionId": 1, "status": 1, "orders": "", "keyWord": "" }] }, { "id": 15, "short_title": "消防设施", "files": [], "title": "建筑消防设施", "optionSelect": [], "type": 1, "optionList": [{ "val": 10, "id": 50, "title": "定期维修保养并记录", "questionId": 15, "status": 1, "orders": "", "keyWord": "" }, { "val": 6, "id": 51, "title": "无记录", "questionId": 15, "status": 1, "orders": "", "keyWord": "" }, { "val": 3, "id": 52, "title": "未定期保养修养", "questionId": 15, "status": 1, "orders": "", "keyWord": "" }, { "val": 10, "id": 53, "title": "不涉及", "questionId": 15, "status": 1, "orders": "", "keyWord": "" }] }],
    curNav: 999990,
    toView: 999990,
    myLocation: null,
    btnDisabled: true,
    btnType: 'primary'
  },
  onLoad: function () {
    this.setData({
      myLocation: getApp().globalData.location

    });

    var that = this
    wx.request({
      url: getApp().globalData.server_url + 'small_question_list.action',
      method: 'GET',
      data: {},
      header: {
        'Accept': 'application/json'
      },
      success: function (res) {
        console.log(res.data)
        that.setData({
          navItems: res.data
        })
      }
    })

  },

  //事件处理函数
  switchRightTab: function (e) {
    // 获取item项的id，和数组的下标值
    let index = e.target.dataset.index;
    this.setData({
      toView: "v" + index,
      curNav: index
    })
  },
  scrollRight: function (e) {

    // let scrollTop = e.detail.scrollTop;
    // var scrollNav = Math.round(scrollTop / this.data.viewHeight);
    //  this.setData({
    //   // curNav: scrollNav
    // })
  },

  optionChange: function (e) {
    let index = e.target.dataset.index;
    let val = e.detail.value;

    var up = "navItems[" + index + "].optionSelect";
    this.setData({
      [up]: [val]
    });


  },
  resultChange: function (e) {
    var result = e.detail.value;
    if (result == 1) {
      this.setData({
        btnType: 'primary',
        btnDisabled: false
      });
    } else {
      this.setData({
        btnType: 'warn',
        btnDisabled: false
      });
    }
  },
  chooseImage: function (e) {
    var that = this;
    let index = e.target.dataset.index;
    var files = that.data.navItems[index].files;
    wx.chooseImage({
      sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
      sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
      success: function (res) {
        // 返回选定照片的本地文件路径列表，tempFilePath可以作为img标签的src属性显示图片
        console.log(files);
        files = files.concat(res.tempFilePaths);

        var up = "navItems[" + index + "].files";
        that.setData({
          [up]: files
        });
      }
    })
  },
  previewImage: function (e) {
    let index = e.target.dataset.index;
    var files = this.data.navItems[index].files;
    wx.previewImage({
      current: e.currentTarget.id, // 当前显示图片的http链接
      urls: files // 需要预览的图片http链接列表
    })
  },
  spliceImage: function (e) {
    var that = this;
    let index = e.target.dataset.index;
    var files = that.data.navItems[index].files;
    files.splice(e.currentTarget.dataset.image_index, 1);
    console.log(files);
    var up = "navItems[" + index + "].files";
    that.setData({
      [up]: files
    });
  },
  submitPage: function (e) {
    var that = this;
    var data = e.detail.value;
	this.setData({
      btnDisabled:true
    });
	wx.showToast({  
        title: '正在提交...',  
        icon: 'loading',  
        mask: true,  
        duration: 100000  
      });
    //上传基本信息
    wx.request({
      url: getApp().globalData.server_url + 'small_collectResult_save.action',
      data: { 'collectResult': data, 'user': getApp().globalData.userInfo },
      method: 'POST', // OPTIONS, GET, HEAD, POST, PUT, DELETE, TRACE, CONNECT
      header: {// 设置请求的 header
        'content-type': 'application/json'
      },
      success: function (res) {

        var success = res.data.success;
        var message = res.data.message;


        if (success) {
          that.submitAnswer(res.data.id);
        } else {
			wx.hideToast(); 
this.setData({
      btnDisabled:false
    });			
          wx.showModal({
            content: message,
            showCancel: false,
            success: function (res) {
            }
          });
        }
      },
      fail: function (res) {
        wx.hideToast();  
      }
    })

  },
  submitAnswer: function (resultId) {
    var that = this;
	
    //上传基本信息
    wx.request({
      url: getApp().globalData.server_url + 'small_question_collect.action',
      data: { 'questionList': that.data.navItems, 'resultId': resultId },
      method: 'POST', // OPTIONS, GET, HEAD, POST, PUT, DELETE, TRACE, CONNECT
      header: {// 设置请求的 header
        'content-type': 'application/json'
      },
      success: function (res) {

        var success = res.data.success;
        var message = res.data.message;


        if (success) {
          that.submitPic(res.data.answerIdList,resultId);
        } else {
			wx.hideToast();  
			this.setData({
      btnDisabled:false
    });		
          wx.showModal({
            content: message,
            showCancel: false,
            success: function (res) {
            }
          });
        }
      },
      fail: function (res) {
		  wx.hideToast();  
        console.log('cuowu' + ':' + res)
      }
    })
  },
  submitPic: function (answerIdList,resultId) {
		var that=this;
		console.log(answerIdList);
		var navItems =this.data.navItems;
		for (var i = 0; i< navItems.length; i++) {  
			var pics = navItems[i].files;
			console.log('navItems[i].id'+navItems[i].id);
			console.log(pics.length);
			for(var j=0;j<pics.length;j++){
				wx.uploadFile({
				  url: getApp().globalData.server_url + 'small_resultPicture_save.action',
				  filePath: pics[j],
				  name: 'uploadImage',
				  header: {  
					"Content-Type": "multipart/form-data",
					'accept': 'application/json',
				  },
				  formData:{
					'resultPicture.resultId':resultId,
					'resultPicture.questionId':navItems[i].id
				  },
				  success: function(res){
						
						console.log('data');
				  },
				  fail: function(res){
					  wx.hideToast();  
					  this.setData({
      btnDisabled:false
    });		
					console.log('fail');
		 
				  },
				})
			}
		        
		
		}
		wx.hideToast();  
		this.setData({
      btnDisabled:false
    });	
	wx.showModal({
            content: '采集成功',
            showCancel: false,
            success: function (res) {
                that.onLoad();
            }
    });
  }
	  

})